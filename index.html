<!DOCTYPE html>
<meta charset="utf-8">
<style>

.link {
  fill: none;
  stroke: #666;
  stroke-width: 1.5px;
}


.overlay {
  fill: none;
  pointer-events: all;
}


.link.Requires {
  stroke-dasharray: 0,2 1;
}

div#graph {
  height: 500px;
  width: 100%;
  border:2px solid #000;
  overflow: auto;
 }

circle {
  fill: #ccc;
  stroke: #333;
}

text {
  font: 10px sans-serif;
  pointer-events: none;
  text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff;
}

</style>
<body>
<script type="text/javascript" src="graph-data.json"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<div id='graph'></div>
<div id='info'></div>
<input type='button' id='hide' value='Hide' class="btn"></input>
<script>

var description = d3.select("#info")
    .append("text")
    .html("<b>Title: </b><br/><b>Number: </b><br/><b>Body: </b><br/><b>ID: </b><br/><b>Repo: </b>")
    .attr('class', 'description');

d3.select('#hide').on( 'click', function() {
  console.log("test");
  hide();
});

var width = window.innerWidth *.9,
    height = window.innerHeight *1,
    radius = 10 //radius of circles
    markerWidth = 6,
    markerHeight = 6,
    refX = radius + (markerWidth * 2),
    refY = 0;

var descriptNode = {
  id: '',
  number: '',
  title: '',
  body: '',
  repo: ''
};

var svg = d3.select("#graph").append("svg")
    .attr("width", width)
    .attr("height", height);

svg.append("defs").selectAll("marker")
    .data(graphData.keywords)
  .enter().append("marker")
    .attr("id", function(d) { return d; })
    .attr("viewBox", "0 -5 10 10")
    .attr("refX", refX)
    .attr("refY", refY)
    .attr("markerWidth", markerWidth)
    .attr("markerHeight", markerHeight)
    .attr("orient", "auto")
  .append("path")
    .attr("d", "M0,-5L10,0L0,5")
    .attr("fill", "#666")
    .attr("stroke", "#666");

var force = d3.layout.force()
    .size([width, height])
    .linkDistance(70)
    .charge(-150)
    .on("tick", tick);

var nodes = force.nodes(),
    links = force.links(),
    node = svg.selectAll(".node"),
    link = svg.selectAll(".link");

function tick() {
  link.attr("x1", function(d) { return d.source.x; })
      .attr("y1", function(d) { return d.source.y; })
      .attr("x2", function(d) { return d.target.x; })
      .attr("y2", function(d) { return d.target.y; });

  node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

  node.select("circle")
      .style("fill", function(d) {
        return repoColor[d.repo];
      })
      .attr("stroke-width", function(d){
                              if(d.id == descriptNode.id){
                                return "5px";
                              } else {
                                return "1.5px";
                              }
      });
}

var linkAll = [];

var nodeDict = {};

var repoColor = {};

graphData.nodes.forEach(function (node) {
  nodeDict[node.id] = node;
  repoColor[node.repo] = node.repo;
})

graphData.links.forEach(function (link) {
  link.source = nodeDict[link.source.id];
  link.target = nodeDict[link.target.id];
  if(nodes.indexOf(link.source)==-1){ nodes.push(link.source); };
  if(nodes.indexOf(link.target)==-1){ nodes.push(link.target); };
  links.push({source: link.source, target: link.target, type: link.type});
});

d3.values(repoColor).forEach( function(repo, i) {
  var hue = i * 360 /d3.values(repoColor).length;
  repoColor[repo] = d3.hsl(hue, .5, .5);
});

function update() {
  link = link.data(links);

  link.enter().insert("line", ".node")
      .attr("class", "link")
      .attr("marker-end", function(d) { return "url(#" + d.type + ")"; });




  link.exit().remove();

  node = node.data(nodes);

  var newnode = node.enter().append("g")
      .on("click", function(d) { click(d);})
      .attr("class", "node")
      .call(force.drag);

  newnode.append("circle")
      .attr("r", radius)
      .style("stroke", "#333");

  newnode.append("text")
      .attr("x", 12)
      .attr("dy", ".35em")
      .text(function(d) { if(d.number == 0){
        return d.title;
      } else {
        return d.number;
      }});

  node.exit().remove();
  force.start();
}


function click(d) {
  console.log("click");
  descriptNode = d; 
  d3.select("text.description")
      .html("<b>Title: </b>"+descriptNode.title+
                                    "<br/><b>Number: </b>"+descriptNode.number+
                                    "<br/><b>Body: </b>"+descriptNode.body+
                                    "<br/><b>ID: </b>"+descriptNode.id+
                                    "<br/><b>Repo: </b>"+descriptNode.repo);
}
update();

function hide(){
  var i = nodes.indexOf(nodeDict[descriptNode.id])
  if (i != -1){
    var removed = nodes.splice(i,1);
    for(var i=0; i<links.length; i++){
      if(links[i].source.id == removed[0].id || links[i].target.id == removed[0].id){
        links.splice(i,1);
        i--;
      }
    }
  }

  descriptNode = {
    id: '',
    number: '',
    title: '',
    body: '',
    repo: ''
  };
  update();
}

</script>